# Changelog: November 20-25, 2025

All notable changes implemented between Thursday, November 20 and Monday, November 25, 2025.

---

## Features

### Search & Discovery

- **Project-wide search implementation** (Phase 1 & 2)
  - Add Payload Search Plugin configuration with localization support
  - Implement KBar command palette with brand styling and locale-aware routing
  - Add search API endpoint with locale filtering and pagination
  - Implement beforeSync hook with text extraction, stopword filtering, and relationship denormalization
  - Add German and English stopword lists for search filtering
  - Add static JSON backup with client-side fallback for enhanced reliability
  - Improve search index with complete artist/employee data and proper display titles
  - Fix employee search indexing (use slug-based routing, proper name extraction)
  - Add reindex script for search schema updates

### Pages Collection & Static Content

- **Add Pages collection for CMS-managed static content**
  - Create Pages collection with localized title, slug, and rich text content
  - Add service layer (getPageBySlug, getPages) for page retrieval
  - Implement dedicated routes for legal pages (impressum/imprint, datenschutz/privacy-policy)
  - Add contact page using Pages collection
  - Add CMS-editable content to team page
  - Add pathname mappings for localized URLs (kontakt/contact, impressum/imprint, etc.)
  - Integrate with search plugin (priority: 25)

### Repertoire Management

- **Implement Repertoire collection with WordPress migration**
  - Create separate Repertoire collection with localized fields (title, description)
  - Add relationship to Artists collection
  - Implement admin UI with custom row labels showing title + artist count
  - Add WordPress migration script with proper Lexical conversion
  - Successfully migrated 32 repertoire entries (16 EN + 16 DE)
  - Add Repertoire tab to artist pages with formatted content display

### Recordings & Discography

- **Complete Recordings collection with migration**
  - Add Recordings collection backend with localized fields
  - Create recording service layer with comprehensive tests
  - Migrate WordPress discography data with intelligent parsing
  - Integrate recordings into artist detail page discography tab
  - Add role filter to recordings tab (Conductor, Soloist, Chamber Music, etc.)
  - Add 'All' filter option with left-aligned toggle group
  - Implement list view for recordings with full-width layout
  - Remove 10-item limit on recordings queries for complete data display

- **Enhance migration intelligence**
  - Replace unreliable content-based role detection with H1 heading structure
  - Add intelligent role detection based on document structure
  - Make migration script idempotent to prevent duplicates
  - Enhance richText parsing for complex WordPress content
  - Extract recording year from label/catalog line
  - Handle real-world label/catalog formats
  - Process DE and EN locales separately
  - Remove 'Partner: ' prefix from recording descriptions
  - Merge composer field into title for cleaner presentation

- **Refactor discography structure**
  - Migrate to role-based array format with separate recordings fields
  - Separate artists and roles fields for independent filtering
  - Add custom row labels for discography sections and YouTube videos
  - Add repertoire section toggle UI

### Artist Pages & UI

- **Improve artist tabs interface**
  - Implement artist detail page tabs with lazy-loaded content (Biography, Recordings, Repertoire)
  - Move highlight quote into Biography tab
  - Refine tabs UI with brand styling and smooth transitions
  - Add UI components and i18n for artist tabs foundation
  - Improve header alignment and overall UX

- **Enhance artist list and discovery**
  - Improve artist list layout and sorting for better discoverability
  - Move image slider below artist grid to prioritize browsing
  - Add "Discover More Artists" section with multi-item slider (2 artists per slide)
  - Implement instrument-based sorting (conductor, piano, violin, etc.) with alphabetical ordering
  - Standardize all artist images to 4:3 aspect ratio
  - Add fade animations and reduce text size for better visual hierarchy

### NewsFeed & Posts

- **Complete NewsFeed component system**
  - Add NewsFeed component system with comprehensive tests
  - Add post detail pages with static generation
  - Add post filtering service with comprehensive tests
  - Integrate NewsFeed components across application
  - Add slug field to Posts with improved localization strategy
  - Add explicit artist relationships to Posts collection
  - Add posts seeding script

### WordPress Migration Infrastructure

- **Comprehensive migration tooling**
  - Add WordPress to Payload CMS migration infrastructure
  - Add WordPress XML exports and migration mapping files
  - Migrate employees from WordPress with proper data structure
  - Migrate artists from WordPress with biography conversion
  - Fix HTML to Lexical converter to preserve newlines and paragraph structure
  - Add Lexical format normalization to handle older dump formats
  - Fix image display to use local media URLs

## Fixes

### Type Safety & Error Handling

- Add error handling to page service functions (try-catch with logging)
- Use proper TypeScript type (SerializedEditorState) for PayloadRichText content
- Fix proper TypeScript type for PayloadRichText content
- Add locale validation utilities

### Routing & Localization

- Handle dynamic routes correctly in LocaleSwitcher (fixes 'Insufficient params provided' error)
- Use next-intl router in SearchProvider for proper locale handling
- Add setRequestLocale and locale extraction to all Pages routes
- Fix impressum/datenschutz routes showing wrong language content
- Preserve URL hash fragments during locale switching
- Fix Header component locale type annotation

### Data Integrity

- Preserve newlines in HTML to Lexical converter (fixed line 288 trim() issue)
- Fix employee search indexing name extraction
- Include all localized field data in collection dumps
- Prevent empty migration entries with improved filtering
- Support H2 headings in discography migration script
- Add proper Lexical editor metadata to migration script
- Fix Claire Huangci featured quote validation error

### UI & Display

- Show role filter even with single role
- Fix logo in footer
- Add proper spacing and alignment in recording cards

## Refactoring

### Code Organization

- Consolidate page routes with shared StaticPageLayout component (reduces ~30 lines to ~12 per route)
- Extract test mock factories to eliminate boilerplate
- Remove payload parameter from service functions (initialize internally)
- Colocate test files with modules and rename to .spec.ts convention
- Organize scripts into logical folders (db/, utils/, wordpress/)
- Establish tmp/ folder structure for temporary scripts

### Architecture Improvements

- Refactor discography structure to role-based array format
- Add reusable media service with asset helpers
- Refactor to save images as webp format
- Rename util components for clarity

### Component Improvements

- Update Payload configuration for migration workflow
- Simplify database configuration to use remote Turso only
- Fix recording service tests with correct limit parameter
- Remove pagination limits across services for complete data display

## Documentation

### Architecture Decision Records (ADR)

- Add database backup strategy ADR
- Add next-intl adoption ADR (archived)
- Add Vercel deployment strategy ADR (archived)

### Implementation Plans

- Add detailed implementation plan for project-wide search
- Add refined project-wide search design document
- Add Recording collection implementation plan
- Add repertoire collection architecture design
- Add footer refactoring design document
- Add NewsFeed implementation documentation
- Archive completed implementation plans (artist list, YouTube links, tabs, repertoire, etc.)

### Agent Guidelines

- **Add database protection policy to AGENTS.md** (critical)
  - Never modify databases without explicit user confirmation
  - Always verify database environment first (local vs remote)
  - Document incident log for accountability
- Add WordPress migration data integrity guidelines
- Add Payload CMS search plugin localization guidance

### API & Usage Documentation

- Add comprehensive JSDoc comments to all service functions
- Add comprehensive JSDoc to database scripts
- Add comprehensive JSDoc to remaining scripts
- Improve Pages collection documentation with examples
- Add contact page setup instructions

## Testing

- Add comprehensive testing infrastructure with Vitest (51 passing tests)
- Add test infrastructure for next-intl components
- Add comprehensive unit tests for Footer components
- Test all service layers: artist, employee, media, post, recording

## Chore

### Data Management

- Update collection dumps with latest changes (multiple updates throughout period)
- Add Pages collection dump
- Dump collections after migrations
- Update data dumps and planning docs after migrations
- Clean up duplicate repertoire entries

### Dependencies & Configuration

- Update node version
- Add dependabot overrides
- Update importmap for admin panel
- Add Tailwind typography plugin support for Tailwind CSS v4
- Add mise.toml for tool version management

### Code Cleanup

- Remove temporary debug and utility scripts
- Remove obsolete populateArtistSlugs migration script
- Remove deprecated individual WordPress XML exports
- Remove employee seed script and JSON data (migrated from WordPress)
- Update seed scripts to remove employee seeding
- Don't render utility components in production

### Formatting & Style

- Apply prettier formatting to database dumps and tmp README
- Format tmp/README.md tables and spacing
- Add trailing newlines to WordPress data files
- Update gitignore to exclude WordPress migration temporary files

## Statistics

- **Total commits**: 145
- **Test coverage**: 51 passing tests across all services
- **Data migrated**:
  - 23 artists with biographies
  - 32 repertoire entries (16 EN + 16 DE)
  - All employee records
  - Complete discography data
  - Media library with alt text

---

_Generated from git log between 2025-11-20 and 2025-11-25_

## 2025-11-27: R2 Storage Investigation & Database Cleanup

### Fixed

- **Database**: Regenerated 64 media records with broken `/null` URLs (commit 54792b7)
- **Migration Script**: Fixed `scripts/db/migrateMediaToR2.ts` to handle null filenames properly
- **Production Images**: All public-facing artist images now load correctly from R2

### Attempted But Reverted

- Simplified R2 storage configuration (commits 61f26b9, 3e0363e, 3d9e54b)
  - Removed `disablePayloadAccessControl: true`
  - Result: No change to admin thumbnails, reverted in bf10f46

### Known Issues

- Admin panel thumbnails still not displaying (see `docs/issues.md`)
- Root cause unknown, likely CORS/CSP or plugin compatibility issue
- Public site unaffected, images work correctly

### Key Learnings

- `disablePayloadAccessControl: true` does NOT fix admin thumbnails (contrary to initial hypothesis)
- Migration script bugs can cause `/null` strings in generated image URLs
- Simplifying configuration had no effect on thumbnail behavior

### Related Documentation

- `docs/issues.md` - Detailed investigation notes and next steps
- `scripts/db/migrateMediaToR2.ts` - Fixed migration script

## 2025-11-29: Mobile UX Improvements & Dependency Updates

### Features

- **iOS Safe Area Support** (commit 64f3a41)
  - Add `.pb-safe` Tailwind utility class following CSS-Tricks pattern
  - Apply mobile-only safe-area padding to footer (respects iOS home bar)
  - Add responsive override (`md:pb-8`) to reset padding on larger screens
  - Prevents footer content from being hidden under iOS home bar on newer iPhones

### Chore

- **Dependency Updates**
  - Update `baseline-browser-mapping` from 2.8.28 to 2.8.32
  - Ensures accurate browser compatibility data for CSS feature detection
