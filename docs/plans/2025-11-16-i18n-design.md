# i18n Architecture & Language Switcher (Next.js App Router + next-intl + Payload CMS)

## 1. Overview & Goals

This plan describes a robust, flexible, and maintainable approach for implementing a language switcher and fully
localized URLs in a Next.js App Router project using [next-intl](https://amannn.github.io/next-intl/) for
internationalization and Payload CMS for content. The goal is to provide:

- Fully localized, SEO-friendly URLs (e.g., `/kuenstler` for German, `/en/artists` for English)
- A single set of page files per logical route
- Efficient, reliable language switching for both static and dynamic content
- Minimal API calls and maximum maintainability

## 2. Official Documentation References

- **next-intl**
  - [Routing Configuration](https://next-intl.dev/docs/routing/configuration)
  - [Dynamic Segments](https://next-intl.dev/docs/routing/configuration#dynamic-segments)
  - [Middleware Setup](https://next-intl.dev/docs/routing/middleware)
  - [Navigation Helpers](https://next-intl.dev/docs/routing/navigation)
  - [Locale Detection](https://next-intl.dev/docs/routing/setup)
- **Payload CMS**
  - [Localization Overview](https://payloadcms.com/docs/localization/overview)
  - [Field-Level Localization](https://github.com/payloadcms/payload/blob/main/docs/configuration/localization.mdx)
  - [Local API Usage](https://github.com/payloadcms/payload/blob/main/docs/local-api/overview.mdx)
  - [Fetching Localized Documents](https://github.com/payloadcms/payload/blob/main/docs/configuration/localization.mdx#find-localized-documents-using-payload-local-api-with-javascript)
- **Next.js**
  - [App Router Internationalization](https://nextjs.org/docs/app/guides/internationalization)
  - [App Router Routing Overview](https://nextjs.org/docs/app/building-your-application/routing)

## 3. Architecture & Rationale

- **Why next-intl?**
  - Enables fully localized URLs and dynamic segments per locale
  - Centralizes routing config and navigation helpers
  - Middleware for locale negotiation and SEO
- **Why Payload CMS?**
  - Field-level localization for slugs and content
  - Efficient API for fetching all localizations in one call
- **Key Decisions:**
  - Use a single API call to fetch all localized slugs for dynamic content
  - Use next-intl’s routing config for all URL mapping
  - No React context or global state for locale

## 4. Directory & Routing Structure

- Single set of page files per logical route (e.g., `app/artists/page.tsx`, `app/artists/[slug]/page.tsx`)
- All localized URLs defined in `src/i18n/routing.ts` using next-intl’s `defineRouting`
- No need to duplicate folders for each locale
- No `/de/` prefix for the default locale if `localePrefix: 'as-needed'` is set

## 5. next-intl & Payload CMS Integration

- **Payload config:**
  - `slug` field on Artist collection is `localized: true`
  - `localizations` field enabled (default in recent Payload)
- **Fetching slugs:**
  - Fetch artist by slug and locale, including all localizations
  - Build `alternateSlugs` object from the `localizations` array
- **next-intl routing config:**
  - Define all localized pathnames and dynamic segments in `src/i18n/routing.ts`

## 6. Language Switcher Design

- **Responsibilities:**
  - Display available languages
  - Highlight current language
  - Link to equivalent page in other language (using correct slug)
  - Handle missing translations gracefully
  - Be accessible (ARIA, keyboard, screen reader)
- **Integration:**
  - Receives `alternateSlugs` from page component
  - Uses next-intl’s `Link` and routing helpers
- **Example:**

  ```tsx
  import { Link, usePathname, useLocale } from 'next-intl/navigation'
  import { routing } from '@/i18n/routing'

  const SUPPORTED_LOCALES = [
    { code: 'de', label: 'Deutsch' },
    { code: 'en', label: 'English' },
  ]

  export default function LanguageSwitcher({ alternateSlugs }) {
    const pathname = usePathname()
    const currentLocale = useLocale()
    return (
      <nav aria-label="Language selector">
        <ul style={{ display: 'flex', gap: 8 }}>
          {SUPPORTED_LOCALES.map(({ code, label }) => {
            const slug = alternateSlugs[code]
            const targetPath = slug
              ? routing.getLocalizedPathname('/artists/[slug]', code, { slug })
              : routing.getLocalizedPathname('/', code)
            const isCurrent = code === currentLocale
            return (
              <li key={code}>
                <Link
                  href={targetPath}
                  locale={code}
                  aria-current={isCurrent ? 'page' : undefined}
                  style={{
                    fontWeight: isCurrent ? 'bold' : 'normal',
                    pointerEvents: isCurrent ? 'none' : undefined,
                    opacity: isCurrent ? 0.6 : 1,
                  }}
                >
                  {label}
                </Link>
              </li>
            )
          })}
        </ul>
      </nav>
    )
  }
  ```

## 7. Implementation Steps

1. Install next-intl: `pnpm add next-intl`
2. Create `src/i18n/routing.ts` with your locales, default locale, and localized pathnames
3. Add `middleware.ts` at the project root using next-intl’s `createMiddleware` and your routing config
4. Use a single set of page files for each logical route
5. Use `getLocale()` from next-intl/server in your page components
6. Fetch all localizations in one API call and build `alternateSlugs` for the switcher
7. Use next-intl’s `Link` and navigation helpers for all internal links and language switchers
8. Test all localized URLs and navigation
9. Document the routing config and how to add new localized routes

## 8. Edge Case Analysis

| Edge Case                     | Risk/Impact                | Status/Recommendation           |
| ----------------------------- | -------------------------- | ------------------------------- |
| Missing translation/slug      | 404 or fallback            | **Handled by Payload fallback** |
| Locale switch on dynamic page | Wrong slug or 404          | **Handled by consistent slugs** |
| Default locale prefix         | SEO/canonical issues       | Handled by next-intl config     |
| Static/dynamic route config   | 404s, broken links         | Handled by next-intl config     |
| Link/navigation handling      | Broken navigation/SEO      | Use next-intl `Link` everywhere |
| SEO alternate links           | SEO issues                 | Use next-intl/SEO plugin        |
| Middleware matcher            | Broken API/static files    | Use recommended matcher         |
| Locale detection/cookie       | Wrong locale, UX issues    | Handled by next-intl middleware |
| Adding new locales/routes     | 404s, missing translations | Update config and translations  |
| Payload CMS integration       | Routing/link breakage      | **Handled by your data model**  |

## 9. SEO & Accessibility

- Use next-intl’s routing config and helpers to generate `<link rel="alternate" hreflang="...">` tags in your layouts or
  pages
- Alternatively, use a general SEO plugin (like next-seo) or your CMS’s SEO plugin (e.g., Payload SEO plugin) in
  combination with next-intl’s routing info
- Example:

  ```tsx
  // app/layout.tsx or app/[...]/layout.tsx
  import { routing } from '@/i18n/routing'
  import { getLocale } from 'next-intl/server'
  import { usePathname } from 'next-intl/navigation'
  export default async function RootLayout({ children }) {
    const locale = await getLocale()
    const pathname = usePathname()
    return (
      <html lang={locale}>
        <head>
          {routing.locales.map((loc) => (
            <link key={loc} rel="alternate" hrefLang={loc} href={routing.getLocalizedPathname(pathname, loc)} />
          ))}
        </head>
        <body>{children}</body>
      </html>
    )
  }
  ```

- Ensure all navigation and switcher components are accessible (ARIA, keyboard, screen reader)

## 10. Documentation & Maintenance

- Update all project documentation (README, onboarding guides, developer docs) to reflect the next-intl-based routing
  and language switcher setup
- Clearly document the process for adding new content, pages, or routes:
  - How to update `src/i18n/routing.ts` with new localized pathnames
  - How to add new page files (single set per logical route)
  - How to add new locales or translations
  - How to use next-intl’s helpers for navigation and language switching
  - How to ensure Payload CMS slugs and fallbacks are configured for new content
- Ensure that all team members and future maintainers understand the workflow for expanding the site’s content and
  routes in a localized, SEO-friendly way
