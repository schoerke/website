# i18n Architecture & Language Switcher (Next.js App Router + next-intl + Payload CMS)

## Status: ✅ IMPLEMENTED (2025-11-16)

## 1. Overview & Goals

This document describes the implemented i18n architecture for a Next.js App Router project using
[next-intl](https://amannn.github.io/next-intl/) for internationalization and Payload CMS for content management.

**Implemented Features:**

- Locale-prefixed URLs using `[locale]` segment (e.g., `/de/artists`, `/en/artists`)
- Single set of page files per logical route in `app/(frontend)/[locale]/`
- Server and client component translation patterns
- Payload CMS integration with locale-aware queries
- Translated UI components (navigation, instrument filters, artist cards)
- SEO-friendly with proper `lang` attributes and locale-aware routing

**Goals Achieved:**

- ✅ Locale-prefixed, SEO-friendly URLs
- ✅ Single set of page files per logical route
- ✅ Efficient locale switching with proper link handling
- ✅ Minimal API calls and maximum maintainability

**Note:** This implementation uses locale prefixes (e.g., `/en/artists`) rather than fully localized paths (e.g.,
`/kuenstler`). The page slugs remain the same across languages, with only the locale prefix changing.

## 2. Official Documentation References

- **next-intl**
  - [Routing Configuration](https://next-intl.dev/docs/routing/configuration)
  - [Dynamic Segments](https://next-intl.dev/docs/routing/configuration#dynamic-segments)
  - [Middleware Setup](https://next-intl.dev/docs/routing/middleware)
  - [Navigation Helpers](https://next-intl.dev/docs/routing/navigation)
  - [Locale Detection](https://next-intl.dev/docs/routing/setup)
- **Payload CMS**
  - [Localization Overview](https://payloadcms.com/docs/localization/overview)
  - [Field-Level Localization](https://github.com/payloadcms/payload/blob/main/docs/configuration/localization.mdx)
  - [Local API Usage](https://github.com/payloadcms/payload/blob/main/docs/local-api/overview.mdx)
  - [Fetching Localized Documents](https://github.com/payloadcms/payload/blob/main/docs/configuration/localization.mdx#find-localized-documents-using-payload-local-api-with-javascript)
- **Next.js**
  - [App Router Internationalization](https://nextjs.org/docs/app/guides/internationalization)
  - [App Router Routing Overview](https://nextjs.org/docs/app/building-your-application/routing)

## 3. Architecture & Rationale

- **Why next-intl?**
  - Enables locale-prefixed URLs with `[locale]` dynamic segment
  - Centralizes routing config and navigation helpers
  - Middleware for locale negotiation and SEO
  - Client and server component translation support
- **Why Payload CMS?**
  - Field-level localization for content
  - Efficient API for fetching localized content
- **Key Decisions:**
  - Use locale prefix pattern (`/de/artists`, `/en/artists`) instead of fully custom paths
  - Single API call per page to fetch content for current locale
  - Use next-intl's Link component for locale-aware navigation
  - No React context or global state for locale - comes from URL params
  - Explicit locale passing to all translation functions in server components

## 4. Directory & Routing Structure

**Actual Implementation:**

- All localized pages live under `app/(frontend)/[locale]/`
- Page slugs are the same across locales (e.g., both use `/artists`, not `/kuenstler`)
- Locale prefix determines language (e.g., `/de/artists` vs `/en/artists`)
- Content and UI translations come from next-intl translation files
- Payload CMS content is fetched with locale parameter

**Example URLs:**

- German: `/de`, `/de/artists`, `/de/team`, `/de/artists/christian-zacharias`
- English: `/en`, `/en/artists`, `/en/team`, `/en/artists/christian-zacharias`

**Route Structure:**

```
src/app/(frontend)/
├── [locale]/          # Locale-prefixed routes
│   ├── page.tsx       # /de or /en
│   ├── artists/
│   │   ├── page.tsx   # /de/artists or /en/artists
│   │   └── [slug]/    # /de/artists/[slug] or /en/artists/[slug]
│   ├── team/
│   ├── contact/
│   └── ...
└── brand/             # Non-localized route (exception)
```

## 5. next-intl & Payload CMS Integration

**Payload Configuration:**

- Collections have `localization: true` enabled
- Content fields can be localized per language
- Queries accept `locale` parameter: `payload.find({ collection: 'artists', locale: 'de' })`

**Fetching Localized Content:**

```typescript
// In page component
const { locale } = await params
const payload = await getPayload({ config })
const result = await payload.find({
  collection: 'artists',
  locale: locale as 'de' | 'en',
  // ... other query params
})
```

**Translation Pattern:**

```typescript
// Server component
const { locale } = await params
const t = await getTranslations({ locale, namespace: 'custom.pages.artists' })

// Client component
const t = useTranslations('custom.instruments')
```

## 6. Language Switcher Design

**Status:** Not yet implemented - footer currently shows links but no active language switcher component.

**Planned Responsibilities:**

- Display available languages (DE/EN)
- Highlight current language
- Link to equivalent page in other language
- Handle missing translations gracefully
- Be accessible (ARIA, keyboard, screen reader)

**Integration Approach:**

- Will use next-intl's `Link` component with `locale` prop
- Can read current locale from `useLocale()` hook
- Links maintain current page path with different locale prefix

**Example Pattern:**

```tsx
import { Link, useLocale } from 'next-intl'
import { routing } from '@/i18n/routing'

export default function LanguageSwitcher() {
  const currentLocale = useLocale()
  return (
    <nav>
      {routing.locales.map((locale) => (
        <Link key={locale} href="/" locale={locale} aria-current={locale === currentLocale ? 'page' : undefined}>
          {locale.toUpperCase()}
        </Link>
      ))}
    </nav>
  )
}
```

## 7. Implementation Steps

**Completed:**

1. ✅ Installed next-intl: `pnpm add next-intl`
2. ✅ Created `src/i18n/routing.ts` with locale configuration
3. ✅ Added `middleware.ts` at project root using next-intl's `createMiddleware`
4. ✅ Created page files under `app/(frontend)/[locale]/` for each route
5. ✅ Implemented locale extraction from params in all page components
6. ✅ Updated service layer to accept and pass locale to Payload queries
7. ✅ Created translation files (`src/i18n/en.ts`, `src/i18n/de.ts`)
8. ✅ Updated all components to use next-intl's `Link` for navigation
9. ✅ Implemented server component translation pattern with explicit locale
10. ✅ Implemented client component translation pattern with hooks
11. ✅ Fixed layout architecture to provide proper html/body tags
12. ✅ Applied consistent styling across all pages

**Remaining:**

- ⏳ Implement dedicated language switcher component (currently just footer links)
- ⏳ Add hreflang meta tags for SEO
- ⏳ Test all edge cases thoroughly
- ⏳ Add E2E tests for locale switching

**Future Considerations:**

- ⚠️ Middleware will be deprecated in future versions of next-intl in favor of server-side locale detection using the
  Request API
- See: <https://next-intl.dev/blog/next-intl-3-22#adopting-the-request-api-stable>
- Migration will require updating from middleware-based routing to server-side locale detection in layouts

## 8. Implementation Findings & Solutions

### Critical Translation Pattern Discovery

**Issue:** Server components cannot use `useTranslations` hook; must use `getTranslations` with explicit locale.

**Solution Implemented:**

- **Server Components:** Use `getTranslations({ locale, namespace: '...' })` with explicit locale from `params`
- **Client Components:** Use `useTranslations('namespace')` hook (requires `'use client'` directive)

**Files Updated:**

- All page components now properly extract locale from `params` and pass to `getTranslations`
- `Footer.tsx` receives locale as prop from layout
- `ArtistCard.tsx` and `InstrumentFilter.tsx` converted to client components for dynamic translation

### Layout Architecture Issues

**Issue:** Pages outside `[locale]` segment missing `<html>` and `<body>` tags causing runtime errors.

**Solution:**

- Moved `impressum` and `datenschutz` back into `[locale]` segment (they have translations)
- Kept `brand` outside with separate layout (static page, to be deleted)
- `[locale]/layout.tsx` provides `<html lang={locale}>` and `<body>` for all localized pages

### Navigation Link Discovery

**Issue:** Using standard Next.js `Link` doesn't maintain locale context; causes broken navigation.

**Solution:**

- All internal links now use `Link` from `@/i18n/navigation`
- Exception: Non-localized routes (e.g., `/brand`) use standard `next/link` with conditional rendering in Footer

### Component Localization Pattern

**Instruments Translation:**

- Instrument keys stored in Payload (e.g., 'piano', 'violin')
- Translated dynamically using `custom.instruments` namespace
- Applied to both ArtistCard display and InstrumentFilter tabs

## 9. Edge Case Analysis & Resolution

| Edge Case                     | Risk/Impact            | Status                                  |
| ----------------------------- | ---------------------- | --------------------------------------- |
| Missing translation/slug      | 404 or fallback        | ✅ Handled by Payload fallback          |
| Locale switch on dynamic page | Wrong slug or 404      | ✅ Handled by consistent slugs          |
| Default locale prefix         | SEO/canonical issues   | ✅ Handled by next-intl config          |
| Static/dynamic route config   | 404s, broken links     | ✅ Handled by next-intl config          |
| Link/navigation handling      | Broken navigation/SEO  | ✅ Using next-intl `Link` everywhere    |
| SEO alternate links           | SEO issues             | ✅ `lang` attribute on `<html>`         |
| Server vs client translations | Wrong locale displayed | ✅ Explicit locale passing implemented  |
| Mixed localized/non-localized | 404s, broken links     | ✅ Conditional Link rendering in Footer |
| Component translation         | Static/untranslated UI | ✅ Client components with hooks         |
| Layout nesting                | Missing html/body tags | ✅ Proper layout hierarchy established  |

## 9. SEO & Accessibility

**Implemented:**

- ✅ Proper `lang` attribute on `<html>` element based on current locale
- ✅ Locale-aware navigation using next-intl Link component
- ✅ Translated aria-labels in components (e.g., InstrumentFilter tabs)

**To Be Implemented:**

- ⏳ Add `<link rel="alternate" hreflang="...">` tags for each locale
- ⏳ Add proper Open Graph locale tags
- ⏳ Ensure language switcher component meets WCAG accessibility standards

**Example for Future Implementation:**

```tsx
// In layout.tsx
import { routing } from '@/i18n/routing'

export default async function LocaleLayout({ children, params }: Props) {
  const { locale } = await params

  return (
    <html lang={locale}>
      <head>
        {/* Add alternate language links */}
        {routing.locales.map((loc) => (
          <link key={loc} rel="alternate" hrefLang={loc} href={`/${loc}${pathname}`} />
        ))}
      </head>
      <body>{children}</body>
    </html>
  )
}
```

## 10. Implementation Summary

### Files Modified by Category

**Service Layer (3 files):**

- `src/services/artist.ts` - Added locale parameter to all queries
- `src/services/employee.ts` - Added locale parameter to all queries
- `src/services/post.ts` - Added locale parameter to all queries

**Pages (9 files):**

- `src/app/(frontend)/[locale]/page.tsx` - Homepage with explicit locale
- `src/app/(frontend)/[locale]/artists/page.tsx` - Artists list
- `src/app/(frontend)/[locale]/artists/[slug]/page.tsx` - Artist detail
- `src/app/(frontend)/[locale]/contact/page.tsx` - Contact page
- `src/app/(frontend)/[locale]/news/page.tsx` - News page
- `src/app/(frontend)/[locale]/projects/page.tsx` - Projects page
- `src/app/(frontend)/[locale]/team/page.tsx` - Team page
- `src/app/(frontend)/[locale]/impressum/page.tsx` - Legal notice (moved into locale)
- `src/app/(frontend)/[locale]/datenschutz/page.tsx` - Privacy policy (moved into locale)

**Components (4 files):**

- `src/components/Footer/Footer.tsx` - Receives locale prop, conditional Link rendering
- `src/components/Artist/ArtistCard.tsx` - Client component with instrument translation
- `src/components/Artist/InstrumentFilter.tsx` - Translated filter tabs
- `src/components/ui/ImageSlider.tsx` - Uses i18n Link

**Layouts (2 files):**

- `src/app/(frontend)/[locale]/layout.tsx` - Provides html/body, passes locale to Footer
- `src/app/(frontend)/brand/layout.tsx` - Standalone layout for non-localized brand page

**Translation Files (2 files):**

- `src/i18n/en.ts` - English translations (pages, instruments, footer)
- `src/i18n/de.ts` - German translations (pages, instruments, footer)

### Translation Namespaces

```typescript
custom: {
  instruments: {
    piano: 'Piano' | 'Klavier',
    violin: 'Violin' | 'Violine',
    // ... other instruments
  },
  pages: {
    home: { title: 'Home' | 'Start' },
    artists: { title: 'Artists' | 'Künstler:innen' },
    artist: {
      backButton: 'Back to Artists' | 'Zurück zu den Künstlern',
      contactPersons: 'Contact Persons' | 'Ansprechpartner'
    },
    // ... other pages
  },
  footer: {
    copyright: 'All rights reserved.' | 'Alle Rechte vorbehalten.'
  }
}
```

### Route Structure

```
src/app/(frontend)/
├── layout.tsx (pass-through)
├── page.tsx (redirects to /[defaultLocale])
├── [locale]/
│   ├── layout.tsx (html/body, NextIntlClientProvider, Header, Footer)
│   ├── page.tsx
│   ├── artists/
│   │   ├── page.tsx
│   │   └── [slug]/page.tsx
│   ├── contact/page.tsx
│   ├── datenschutz/page.tsx
│   ├── impressum/page.tsx
│   ├── news/page.tsx
│   ├── projects/page.tsx
│   └── team/page.tsx
└── brand/
    ├── layout.tsx (separate html/body for non-localized route)
    └── page.tsx
```

## 11. Best Practices & Developer Guidelines

**Adding New Pages:**

1. Create page file in `src/app/(frontend)/[locale]/your-page/page.tsx`
2. Accept `params: Promise<{ locale: string }>` in component props
3. Extract locale: `const { locale } = await params`
4. Use `getTranslations({ locale, namespace: 'custom.pages.yourPage' })`
5. Add translations to `src/i18n/en.ts` and `src/i18n/de.ts`
6. Use standard page padding: `className="mx-auto flex max-w-7xl flex-col px-4 py-12 sm:px-6 lg:p-8"`

**Creating Client Components with Translations:**

1. Add `'use client'` directive at top of file
2. Import `useTranslations` from `next-intl`
3. Use hook: `const t = useTranslations('namespace')`
4. Component will automatically receive locale from parent `NextIntlClientProvider`

**Service Layer Integration:**

1. All service functions accept `locale: LocaleCode` parameter
2. Pass locale to Payload queries: `payload.find({ collection: '...', locale })`
3. Type as `'de' | 'en'` when calling from pages

**Navigation Links:**

- Use `Link` from `@/i18n/navigation` for all localized routes
- Use `Link` from `next/link` only for non-localized routes (e.g., `/brand`)
- Always use `href` with paths starting from `/` (relative to locale root)
